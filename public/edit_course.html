<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Edit Course - Question Bank System</title>
    <link rel="stylesheet" href="css/style.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
</head>

<body>
    <nav>
        <div class="logo">QB Admin</div>
        <ul>
            <li><a href="admin_dashboard.html">Dashboard</a></li>
        </ul>
    </nav>

    <div class="container">
        <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
            <h2>Edit Course</h2>
            <button onclick="handleDeleteCourse()" class="btn btn-danger">Delete Course</button>
        </div>

        <!-- Edit Course Details -->
        <div class="card">
            <h3>Course Details</h3>
            <form id="editCourseForm">
                <div class="form-group">
                    <label for="title">Course Name</label>
                    <input type="text" id="title" required>
                </div>
                <div class="form-group">
                    <label for="description">Description</label>
                    <textarea id="description" rows="3"></textarea>
                </div>
                <button type="submit" class="btn">Update Details</button>
            </form>
        </div>

        <!-- Add Question -->
        <div class="card">
            <h3>Add Additional Question</h3>
            <form id="addQuestionForm">
                <div class="form-group">
                    <label for="qText">Question Text</label>
                    <textarea id="qText" required rows="3" placeholder="Enter question here..."></textarea>
                </div>
                <button type="submit" class="btn">Add Question</button>
            </form>
        </div>

        <!-- Question List -->
        <div class="card">
            <h3>Existing Questions</h3>
            <div id="questionList"></div>
        </div>
    </div>

    <style>
        .sticky-header {
            position: sticky;
            top: 80px;
            /* Adjust based on nav height */
            z-index: 100;
            background: var(--bg-color);
            padding: 1rem 0;
            border-bottom: 1px solid var(--border-color);
            margin-bottom: 2rem !important;
        }
    </style>
    <script src="js/app.js"></script>
    <script>
        if (localStorage.getItem('role') !== 'admin') {
            window.location.href = 'login_selection.html';
        }

        const urlParams = new URLSearchParams(window.location.search);
        const courseId = urlParams.get('id');

        if (!courseId) {
            alert('No course ID provided');
            window.location.href = 'admin_dashboard.html';
        }

        // Apply sticky class to header container
        document.querySelector('.container > div:first-child').classList.add('sticky-header');
        // Update Delete Button Class
        document.querySelector('.btn-danger').classList.add('btn-danger-dark');
        document.querySelector('.btn-danger').classList.remove('btn-danger');

        async function loadCourse() {
            const data = await getCourse(courseId);
            if (!data.course) {
                alert('Course not found');
                window.location.href = 'admin_dashboard.html';
                return;
            }

            document.getElementById('title').value = data.course.title;
            document.getElementById('description').value = data.course.description || '';

            renderQuestions(data.questions);
        }

        function renderQuestions(questions) {
            const list = document.getElementById('questionList');
            list.innerHTML = '';
            questions.forEach(q => {
                const div = document.createElement('div');
                div.className = 'question-item';
                div.id = `q-${q._id}`;
                div.innerHTML = `
                  <div class="q-content">
                    <p><strong>Q:</strong> <span class="q-text">${q.text}</span></p>
                  </div>
                  <div class="question-actions" style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                    <button class="btn btn-sm btn-secondary" onclick="enableEdit('${q._id}', this)">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="handleDeleteQuestion('${q._id}')">Delete</button>
                  </div>
                `;
                list.appendChild(div);
            });
        }

        function enableEdit(qId, btn) {
            const container = document.getElementById(`q-${qId}`);
            const textSpan = container.querySelector('.q-text');
            const currentText = textSpan.textContent;

            container.innerHTML = `
                <div class="q-edit-form" style="width:100%">
                    <textarea class="edit-input" style="width:100%; padding:0.5rem; margin-bottom:0.5rem;" rows="2">${currentText}</textarea>
                    <div style="display:flex; gap:0.5rem;">
                        <button class="btn btn-sm" onclick="saveEdit('${qId}', this)">Save</button>
                        <button class="btn btn-sm btn-secondary" onclick="cancelEdit('${qId}', '${currentText.replace(/'/g, "\\'")}')">Cancel</button>
                    </div>
                </div>
            `;
        }

        async function saveEdit(qId, btn) {
            const container = document.getElementById(`q-${qId}`);
            const newText = container.querySelector('.edit-input').value;

            btn.disabled = true;
            btn.textContent = 'Saving...';

            try {
                await updateQuestion(qId, { text: newText });
                // Re-render item (simplest way to reset view)
                // Just construct HTML manually to avoid full reload
                container.innerHTML = `
                  <div class="q-content">
                    <p><strong>Q:</strong> <span class="q-text">${newText}</span></p>
                  </div>
                  <div class="question-actions" style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                    <button class="btn btn-sm btn-secondary" onclick="enableEdit('${qId}', this)">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="handleDeleteQuestion('${qId}')">Delete</button>
                  </div>
                `;
            } catch (e) {
                console.error(e);
                alert('Failed to save');
                btn.disabled = false;
                btn.textContent = 'Save';
            }
        }

        function cancelEdit(qId, originalText) {
            const container = document.getElementById(`q-${qId}`);
            container.innerHTML = `
                  <div class="q-content">
                    <p><strong>Q:</strong> <span class="q-text">${originalText}</span></p>
                  </div>
                  <div class="question-actions" style="margin-top:0.5rem; display:flex; gap:0.5rem;">
                    <button class="btn btn-sm btn-secondary" onclick="enableEdit('${qId}', this)">Edit</button>
                    <button class="btn btn-sm btn-danger" onclick="handleDeleteQuestion('${qId}')">Delete</button>
                  </div>
                `;
        }

        document.getElementById('editCourseForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const title = document.getElementById('title').value;
            const description = document.getElementById('description').value;
            const btn = e.target.querySelector('button');
            const card = e.target.closest('.card');

            btn.disabled = true;
            btn.textContent = 'Updating...';

            await updateCourse(courseId, { title, description });

            // Success Feedback
            btn.textContent = 'Update Details';
            btn.disabled = false;
            card.classList.add('success-border');
            setTimeout(() => card.classList.remove('success-border'), 2000);

            // Optional: Toast?
            // alert('Course updated'); // Replaced by green border
        });

        document.getElementById('addQuestionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const text = document.getElementById('qText').value;
            const submitBtn = e.target.querySelector('button');

            submitBtn.disabled = true;
            try {
                const res = await addQuestion(courseId, { text });
                if (res.error) {
                    alert('Error adding question: ' + res.error);
                } else {
                    document.getElementById('addQuestionForm').reset();
                    loadCourse();
                }
            } catch (error) {
                console.error(error);
                alert('Failed to add question');
            } finally {
                submitBtn.disabled = false;
            }
        });

        async function handleDeleteCourse() {
            if (confirm('Are you sure you want to delete this course? This cannot be undone.')) {
                await deleteCourse(courseId);
                window.location.href = 'admin_dashboard.html';
            }
        }

        async function handleDeleteQuestion(qId) {
            if (confirm('Delete this question?')) {
                await deleteQuestion(qId);
                loadCourse();
            }
        }

        loadCourse();
    </script>
</body>

</html>