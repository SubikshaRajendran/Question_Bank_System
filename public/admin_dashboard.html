<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard - Question Bank System</title>
    <link rel="stylesheet" href="css/style.css">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>QB</text></svg>">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        .pagination-controls {
            display: flex;
            justify-content: center;
            gap: 1rem;
            margin-top: 2rem;
            align-items: center;
        }

        .page-btn {
            background: var(--card-bg);
            border: 1px solid var(--border-color);
            padding: 0.5rem 1rem;
            border-radius: 4px;
            cursor: pointer;
            color: var(--text-color);
        }

        .page-btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .course-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 1rem;
        }
    </style>
</head>

<body>
    <nav>
        <div class="logo">QB Admin</div>
        <ul>
            <li><a href="bulk_actions.html">Bulk Actions</a></li>
            <li><a href="add_course.html">Add Course</a></li>
            <li><button id="themeToggleBtn" class="theme-toggle" onclick="toggleTheme()">ðŸŒ™</button></li>
            <li><a href="index.html" onclick="localStorage.clear()">Logout</a></li>
        </ul>
    </nav>

    <div class="container">
        <h2 class="section-header">Admin Overview</h2>

        <!-- Stats Row -->
        <!-- Stats Row -->
        <div class="stats-grid" id="statsGrid"
            style="grid-template-columns: 1fr; max-width: 300px; margin: 0 auto 2rem auto;">
            <div class="stat-card">
                <div class="stat-number" id="statsCourses">-</div>
                <div class="stat-label">Total Courses</div>
            </div>
            <footer class="main-footer">
                <div class="container" style="text-align: center;">
                    <p>&copy; 2026 Question Bank System. All rights reserved.</p>
                </div>
            </footer>
        </div>

        <h2 class="section-header">Manage Courses</h2>

        <!-- Search Bar -->
        <div class="search-container">
            <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="search-icon">
                <circle cx="11" cy="11" r="8"></circle>
                <line x1="21" y1="21" x2="16.65" y2="16.65"></line>
            </svg>
            <input type="text" id="courseSearch" class="search-input" placeholder="Search courses by title..."
                oninput="filterCourses()">
        </div>

        <div id="courseList">
            <!-- Loading state managed by JS -->
            <!-- Empty state managed by JS -->
        </div>

        <div class="pagination-controls" id="paginationControls" style="display: none;">
            <button class="page-btn" onclick="changePage(-1)">Previous</button>
            <span id="pageInfo">Page 1</span>
            <button class="page-btn" onclick="changePage(1)">Next</button>
        </div>
    </div>

    <script src="js/app.js"></script>
    <script src="js/theme.js"></script>
    <script>
        if (localStorage.getItem('role') !== 'admin') {
            window.location.href = 'login_selection.html';
        }

        let allCourses = [];
        let filteredCourses = []; // New state for filtering
        let currentPage = 1;
        const itemsPerPage = 6;

        async function loadCourses() {
            // 1. Load Courses
            try {
                allCourses = await fetchCourses();
                filteredCourses = allCourses;
                renderCourses();
            } catch (err) {
                console.error("Failed to load courses", err);
                document.getElementById('courseList').innerHTML = '<p style="color:red">Failed to load courses. Ensure server is running.</p>';
            }

            // 2. Load Stats (Independent)
            try {
                // Use API_URL from app.js if available, otherwise fallback
                const baseUrl = (typeof API_URL !== 'undefined') ? API_URL : '/api';
                const res = await fetch(`${baseUrl}/analytics/admin/stats`);

                if (res.ok) {
                    const statsRes = await res.json();
                    if (statsRes && statsRes.counts) {
                        const count = statsRes.counts.courses;
                        document.getElementById('statsCourses').textContent = (count !== undefined) ? count : 0;
                    }
                }
            } catch (err) {
                console.error("Failed to load stats", err);
                // Fail silently for stats or show "Err"
                document.getElementById('statsCourses').textContent = "-";
            }
        }

        function filterCourses() {
            const query = document.getElementById('courseSearch').value.toLowerCase();
            filteredCourses = allCourses.filter(course =>
                course.title.toLowerCase().includes(query)
            );
            currentPage = 1; // Reset to first page on search
            renderCourses();
        }

        function renderCourses() {
            const list = document.getElementById('courseList');
            list.innerHTML = '';

            if (filteredCourses.length === 0) {
                // Smart Empty State
                const query = document.getElementById('courseSearch').value;
                if (query) {
                    list.innerHTML = `
                        <div class="no-results">
                            <p>No courses found matching "<strong>${query}</strong>".</p>
                        </div>`;
                } else {
                    list.innerHTML = `
                        <div class="no-results">
                            <p>No courses found. Click 'Add Course' to get started!</p>
                        </div>`;
                }
                document.getElementById('paginationControls').style.display = 'none';
                return;
            }

            const totalPages = Math.ceil(filteredCourses.length / itemsPerPage);

            // Ensure current page is valid
            if (currentPage > totalPages) currentPage = totalPages;
            if (currentPage < 1) currentPage = 1;

            const start = (currentPage - 1) * itemsPerPage;
            const end = start + itemsPerPage;
            const pageCourses = filteredCourses.slice(start, end);

            pageCourses.forEach(course => {
                const div = document.createElement('div');
                div.className = 'card';
                div.innerHTML = `
                  <h3>${course.title}</h3>
                  <p>${course.description || ''}</p>
                  <div class="course-actions">
                    <a href="edit_course.html?id=${course._id}" class="btn">Edit</a>
                    <button class="btn btn-danger" onclick="handleDelete('${course._id}')">Delete</button>
                  </div>
                `;
                list.appendChild(div);
            });

            // Update Pagination Controls
            const controls = document.getElementById('paginationControls');
            if (totalPages > 1) {
                controls.style.display = 'flex';
                document.getElementById('pageInfo').textContent = `Page ${currentPage} of ${totalPages}`;
                controls.children[0].disabled = currentPage === 1;
                controls.children[2].disabled = currentPage === totalPages;
            } else {
                controls.style.display = 'none';
            }
        }

        function changePage(delta) {
            currentPage += delta;
            renderCourses();
        }

        async function handleDelete(id) {
            if (confirm('Are you sure you want to delete this course?')) {
                await deleteCourse(id);
                loadCourses();
            }
        }

        loadCourses();
    </script>
</body>

</html>